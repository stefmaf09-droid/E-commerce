name: Recours E-commerce CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Ensure PyPDF2 is available for PDF text extraction in tests
        pip install PyPDF2>=3.0.0
        pip install pytest pytest-asyncio pytest-cov black flake8

- name: Security: pip-audit (generate JSON)
      run: |
        # Install pip-audit and produce a JSON report for artifact upload.
        python -m pip install --upgrade pip
        pip install pip-audit
        pip-audit --format json --output pip-audit.json

    - name: Upload pip-audit report
      uses: actions/upload-artifact@v4
      with:
        name: pip-audit-report
        path: pip-audit.json

    - name: Fail on high severity vulnerabilities
      run: |
        python - <<'PY'
        import sys, json
        try:
            with open('pip-audit.json') as f:
                r = json.load(f)
        except FileNotFoundError:
            print('pip-audit.json not found; ensure pip-audit ran correctly')
            sys.exit(1)
        max_sev = {'low':0,'medium':1,'high':2,'critical':3}
        found = False
        for item in r:
            for vuln in item.get('vulns', []):
                sev = vuln.get('severity','').lower()
                if max_sev.get(sev, -1) >= 2:
                    print('VULN:', item.get('name'), 'severity=', sev, 'id=', vuln.get('id'))
                    found = True
        if found:
            print('One or more vulnerabilities with severity >= high were found. Failing the job.')
            sys.exit(1)
        print('No vulnerabilities >= high found.')
        PY
        
    - name: Lint with flake8
      run: |
        flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: Run tests with coverage
      run: |
        pytest --cov=src --cov-report=xml
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # CodeQL static analysis job (runs in parallel with tests)
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: Autobuild (best-effort)
        uses: github/codeql-action/autobuild@v2
        # For Python projects autobuild is usually a no-op but safe to include

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  deploy_staging:
    needs: test
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Staging
      run: echo "Deploying to staging environment..."
      
  deploy_production:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Production
      run: echo "Deploying to production environment..."
