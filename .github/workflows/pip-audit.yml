name: Dependency audit (pip-audit)

on:
  push:
    branches: [ main, develop ]
  schedule:
    - cron: '0 4 * * 1' # weekly Monday 04:00 UTC
  workflow_dispatch: {}

jobs:
  pip-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit and save JSON
        run: |
          pip-audit --format json --output pip-audit.json

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit.json

      - name: Fail on high severity
        run: |
          python - <<'PY'
          import sys, json
          try:
              with open('pip-audit.json') as f:
                  r = json.load(f)
          except FileNotFoundError:
              print('pip-audit.json not found; ensure pip-audit ran correctly')
              sys.exit(1)
          max_sev = {'low':0,'medium':1,'high':2,'critical':3}
          found = False
          for item in r:
              for vuln in item.get('vulns', []):
                  sev = vuln.get('severity','').lower()
                  if max_sev.get(sev, -1) >= 2:
                      print('VULN:', item.get('name'), 'severity=', sev, 'id=', vuln.get('id'))
                      found = True
          if found:
              print('One or more vulnerabilities with severity >= high were found. Failing the job.')
              sys.exit(1)
          print('No vulnerabilities >= high found.')
          PY
